---
# Pod with secondary interface, with network-name override
apiVersion: v1
kind: Pod
metadata:
  name: example-aeron-k8s-bootstrap-0
  labels:
    app: example-aeron-k8s-bootstrap
    aeron.io/media-driver: "true"
    test-case: with-secondary-interface-and-network-env-var
  annotations:
    k8s.v1.cni.cncf.io/networks: '[
        { "name": "aeron",
          "ips": [ "192.168.1.200/24" ]
        }]'
spec:
  serviceAccount: aeron-k8s-bootstrap
  volumes:
    # This volume holds the configurated generated by the initcontainer
    - name: aeron-md-config-dir
      emptyDir: {}
    # This is the static configuration properties for all media-drivers
    - name: aeron-properties
      configMap:
        name: aeron-k8s-bootstrap
    # Memory-backed shared memory volume for Aeron
    - name: dshm
      emptyDir:
        medium: Memory
  initContainers:
    - name: aeron-k8s-bootstrap
      image: ghcr.io/james-masson/aeron-k8s-bootstrap/aeron-k8s-bootstrap:latest
      # Don't pull, as we pre-build/pre-load the images for CI
      imagePullPolicy: Never
      env:
        # example config to alter discovery process goes here
        - name: AERON_MD_DISCOVERY_PORT
          value: "8050"
        - name: AERON_MD_SECONDARY_INTERFACE_NETWORK_NAME
          value: "custom-network"
      volumeMounts:
        - name: aeron-md-config-dir
          mountPath: /etc/aeron
  containers:
    # Aeron Media Driver
    - name: media-driver
      image: ghcr.io/james-masson/aeron-k8s-bootstrap/aeronmd:latest
      args:
        - /etc/aeron/bootstrap.properties
        - /etc/aeron/aeron.properties
      # Don't pull, as we pre-build/pre-load the images for CI
      imagePullPolicy: Never
      volumeMounts:
        - mountPath: /etc/aeron/bootstrap.properties
          name: aeron-md-config-dir
          subPath: bootstrap.properties
        - mountPath: /etc/aeron/aeron.properties
          name: aeron-properties
          subPath: aeron.properties
        - mountPath: /dev/shm
          name: dshm

    # TODO: Example Aeron consuming code
---
# Pod with secondary interface, with network-name override
apiVersion: v1
kind: Pod
metadata:
  name: example-aeron-k8s-bootstrap-1
  labels:
    app: example-aeron-k8s-bootstrap
    aeron.io/media-driver: "true"
    test-case: with-secondary-interface-and-network-env-var
  annotations:
    k8s.v1.cni.cncf.io/networks: '[
        { "name": "aeron",
          "ips": [ "192.168.1.201/24" ]
        }]'
spec:
  serviceAccount: aeron-k8s-bootstrap
  volumes:
    # This volume holds the configurated generated by the initcontainer
    - name: aeron-md-config-dir
      emptyDir: {}
    # This is the static configuration properties for all media-drivers
    - name: aeron-properties
      configMap:
        name: aeron-k8s-bootstrap
    # Memory-backed shared memory volume for Aeron
    - name: dshm
      emptyDir:
        medium: Memory
  initContainers:
    - name: aeron-k8s-bootstrap
      image: ghcr.io/james-masson/aeron-k8s-bootstrap/aeron-k8s-bootstrap:latest
      # Don't pull, as we pre-build/pre-load the images for CI
      imagePullPolicy: Never
      env:
        # example config to alter discovery process goes here
        - name: AERON_MD_DISCOVERY_PORT
          value: "8050"
        - name: AERON_MD_SECONDARY_INTERFACE_NETWORK_NAME
          value: "custom-network"
      volumeMounts:
        - name: aeron-md-config-dir
          mountPath: /etc/aeron
  containers:
    # Aeron Media Driver
    - name: media-driver
      image: ghcr.io/james-masson/aeron-k8s-bootstrap/aeronmd:latest
      args:
        - /etc/aeron/bootstrap.properties
        - /etc/aeron/aeron.properties
      # Don't pull, as we pre-build/pre-load the images for CI
      imagePullPolicy: Never
      volumeMounts:
        - mountPath: /etc/aeron/bootstrap.properties
          name: aeron-md-config-dir
          subPath: bootstrap.properties
        - mountPath: /etc/aeron/aeron.properties
          name: aeron-properties
          subPath: aeron.properties
        - mountPath: /dev/shm
          name: dshm

    # TODO: Example Aeron consuming code
---
# Pod with secondary interface, with network-name override
apiVersion: v1
kind: Pod
metadata:
  name: example-aeron-k8s-bootstrap-2
  labels:
    app: example-aeron-k8s-bootstrap
    aeron.io/media-driver: "true"
    test-case: with-secondary-interface-and-network-env-var
  annotations:
    k8s.v1.cni.cncf.io/networks: '[
        { "name": "aeron",
          "ips": [ "192.168.1.202/24" ]
        }]'
spec:
  serviceAccount: aeron-k8s-bootstrap
  volumes:
    # This volume holds the configurated generated by the initcontainer
    - name: aeron-md-config-dir
      emptyDir: {}
    # This is the static configuration properties for all media-drivers
    - name: aeron-properties
      configMap:
        name: aeron-k8s-bootstrap
    # Memory-backed shared memory volume for Aeron
    - name: dshm
      emptyDir:
        medium: Memory
  initContainers:
    - name: aeron-k8s-bootstrap
      image: ghcr.io/james-masson/aeron-k8s-bootstrap/aeron-k8s-bootstrap:latest
      # Don't pull, as we pre-build/pre-load the images for CI
      imagePullPolicy: Never
      env:
        # example config to alter discovery process goes here
        - name: AERON_MD_DISCOVERY_PORT
          value: "8050"
        - name: AERON_MD_SECONDARY_INTERFACE_NETWORK_NAME
          value: "custom-network"
      volumeMounts:
        - name: aeron-md-config-dir
          mountPath: /etc/aeron
  containers:
    # Aeron Media Driver
    - name: media-driver
      image: ghcr.io/james-masson/aeron-k8s-bootstrap/aeronmd:latest
      args:
        - /etc/aeron/bootstrap.properties
        - /etc/aeron/aeron.properties
      # Don't pull, as we pre-build/pre-load the images for CI
      imagePullPolicy: Never
      volumeMounts:
        - mountPath: /etc/aeron/bootstrap.properties
          name: aeron-md-config-dir
          subPath: bootstrap.properties
        - mountPath: /etc/aeron/aeron.properties
          name: aeron-properties
          subPath: aeron.properties
        - mountPath: /dev/shm
          name: dshm

    # TODO: Example Aeron consuming code
