name: "Build"
description: "Build the Go binary and container image"

inputs:
  push-containers:
    description: "Whether to push Docker containers to registry"
    required: false
    default: "false"

runs:
  using: composite
  steps:
    - uses: actions/setup-go@v6
      with:
        go-version: "^1.25"

    - name: Run unit tests
      shell: bash
      run: go test -v

    - name: Build
      shell: bash
      run: CGO_ENABLED=0 GOOS=linux go build

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ github.token }}

    - name: Build and push aeron-k8s-bootstrap container
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile
        push: ${{ inputs.push-containers == 'true' }}
        load: true
        tags: |
          ghcr.io/${{ github.repository }}/aeron-k8s-bootstrap:${{ github.sha }}
          ghcr.io/${{ github.repository }}/aeron-k8s-bootstrap:latest
        cache-from: type=registry,ref=ghcr.io/${{ github.repository }}/aeron-k8s-bootstrap:cache
        cache-to: type=registry,ref=ghcr.io/${{ github.repository }}/aeron-k8s-bootstrap:cache,mode=max

    - name: Build and push aeronmd container
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile-aeronmd
        push: ${{ inputs.push-containers == 'true' }}
        load: true
        tags: |
          ghcr.io/${{ github.repository }}/aeronmd:${{ github.sha }}
          ghcr.io/${{ github.repository }}/aeronmd:latest
        cache-from: type=registry,ref=ghcr.io/${{ github.repository }}/aeronmd:cache
        cache-to: type=registry,ref=ghcr.io/${{ github.repository }}/aeronmd:cache,mode=max
