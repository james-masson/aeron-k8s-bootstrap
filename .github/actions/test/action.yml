name: "Build"
description: "Build the Go binary and container image"

runs:
  using: composite
  steps:
    - name: Start minikube
      uses: medyagh/setup-minikube@latest

    - name: Load everything to minikube
      shell: bash
      run: |
        set -eo pipefail

        # Load images into minikube
        minikube image load ghcr.io/${{ github.repository }}/aeron-k8s-bootstrap:latest
        minikube image load ghcr.io/${{ github.repository }}/aeronmd:latest

        # Install Multus
        kubectl apply -f https://raw.githubusercontent.com/k8snetworkplumbingwg/multus-cni/master/deployments/multus-daemonset-thick.yml

    - name: Deploy to minikube
      shell: bash
      run: kubectl apply -f examples/simple.yml && kubectl rollout status statefulsets.apps example-aeron-k8s-bootstrap --timeout=90s

    - name: Test bootstrapping
      shell: bash
      run: ./check_bootstrap_success.sh
